select case when cc."path" like '/752/%' then 'IEL' end as casa, c.id as curso, c.fullname, case when carga_horaria.value is null or carga_horaria.value = '' then 'Não informado' else carga_horaria.value end as carga_horaria, gpn.name as unidade, array_to_string(array_agg (gp.name), ',') as grupos, u.id, u.username, concat(u.firstname, ' ', u.lastname) as nome, to_timestamp(ue.timestart) as inicio, to_timestamp(ue.timeend) as termino, gi.idnumber as "avaliacao", gi.itemname as "nome avaliacao", gg.finalgrade, case when count(mcmc.id) > 0 and gg.finalgrade is null then 'Em andamento' when count(mcmc.id) = 0 then 'Não Iniciado' when gg.finalgrade > 0 then 'Concluído' end as processo from mdl_course c inner join mdl_enrol e on e.courseid = c.id and e.enrol = 'manual' inner join mdl_course_modules mcm on mcm.course = c.id inner join mdl_user_enrolments ue on ue.enrolid = e.id inner join mdl_user u on u.id = ue.userid left join mdl_course_modules_completion mcmc on mcm.id = mcmc.coursemoduleid and mcmc.userid = u.id inner join mdl_grade_items gi on gi.courseid = c.id and gi.idnumber ~ '^(AE|RE)[0-9](A|R)[0-9]$|RF3R1' inner join mdl_grade_grades gg on gg.itemid = gi.id and gg.userid = u.id inner join mdl_course_categories cc on cc."path" ~ '/752/' and cc.id = c.category inner join mdl_groupings gpn on gpn.courseid = c.id and gpn.idnumber is not null and gpn.idnumber != '' inner join mdl_groupings_groups gpg on gpg.groupingid = gpn.id inner join mdl_groups gp on gp.id = gpg.groupid and gp.courseid = c.id inner join mdl_groups_members gpm on gpm.groupid = gp.id and gpm.userid = u.id left join mdl_customfield_data carga_horaria on carga_horaria.fieldid = 9 and carga_horaria.instanceid = c.id group by casa, curso, c.fullname, u.id, u.username, carga_horaria, nome, inicio, termino, avaliacao, "nome avaliacao", unidade, gg.finalgrade order by nome, c.id desc
