select case when cc."path" like '/64/%' then 'SENAI' when cc."path" like '/743/%' then 'IEL' when cc."path" like '/803/%' then 'SESI' end as casa, c.id as curso, c.fullname, gpn.name as unidade, array_to_string(array_agg (gp.name), ',') as grupos, u.id, u.username, concat(u.firstname, ' ', u.lastname) as nome, to_timestamp(ue.timestart) as inicio, to_timestamp(ue.timeend) as termino, gi.idnumber as "avaliacao", gi.itemname as "nome avaliacao", gg.finalgrade, to_timestamp(gg.timemodified) as "Última Atualização" from mdl_course c inner join mdl_enrol e on e.courseid = c.id and e.enrol = 'manual' inner join mdl_user_enrolments ue on ue.enrolid = e.id inner join mdl_user u on u.id = ue.userid inner join mdl_grade_items gi on gi.courseid = c.id and (gi.idnumber ~ '^(AE|RE)[0-9](A|R)[0-9]$|RF3R1') inner join mdl_grade_grades gg on gg.itemid = gi.id and gg.userid = u.id and gg.timemodified >1641006000 inner join mdl_course_categories cc on cc."path" ~ '/64/' and cc.id = c.category inner join mdl_groupings gpn on gpn.courseid = c.id and gpn.idnumber is not null and gpn.idnumber != '' inner join mdl_groupings_groups gpg on gpg.groupingid = gpn.id inner join mdl_groups gp on gp.id = gpg.groupid and gp.courseid = c.id inner join mdl_groups_members gpm on gpm.groupid = gp.id and gpm.userid = u.id group by casa, curso, c.fullname, u.id, u.username, nome, inicio, termino, avaliacao, "nome avaliacao", unidade, gg.finalgrade, "Última Atualização" order by c.id, u.id desc
